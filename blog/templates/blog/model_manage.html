<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>æ¨¡å‹ç®¡ç†é é¢</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="d-flex flex-column min-vh-100">
    {% include "blog/_navbar.html" %}

    <div class="container">
        <br>
        <h2 class="mb-4 text-center">ğŸ§  æ¨¡å‹ç®¡ç†é é¢</h2>

        <!-- SSH é€£ç·šæç¤º -->
        <div id="ssh-status" class="text-center mb-3"></div>

        <div class="card p-4 shadow-sm fs-5">
            <ul id="model-list" class="list-group"></ul>
        </div>

        <!-- è¿”å›é¦–é æŒ‰éˆ• -->
        <div class="text-center mt-4">
            <a href="/" class="btn btn-secondary btn-lg">ğŸ”™ è¿”å›é¦–é </a>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const sshStatus = document.getElementById('ssh-status');
            const modelList = document.getElementById('model-list');

            const socket = new WebSocket("ws://" + window.location.host + "/ws/CMD/");

            socket.onopen = function() {
                sshStatus.innerHTML = `<span class="text-warning fw-bold">ğŸŸ¡ æ­£åœ¨é€£æ¥ SSH...</span>`;
                socket.send(JSON.stringify({
                    action: "ssh_connect",
                    hostname: "{{ request.session.hostname }}",
                    port: "{{ request.session.port }}",
                    username: "{{ request.session.username }}",
                    password: "{{ request.session.password }}"
                }));
            };

            socket.onmessage = function(e) {
                const data = JSON.parse(e.data);

                if (data.type === 'ssh_status') {
                    if (data.status === 'success') {
                        sshStatus.innerHTML = `<span class="text-success fw-bold">ğŸŸ¢ SSH å·²é€£ç·š</span>`;
                        socket.send(JSON.stringify({ action: "list-models" }));
                    } else {
                        sshStatus.innerHTML = `<span class="text-danger fw-bold">ğŸ”´ SSH é€£ç·šå¤±æ•—</span>`;
                    }
                }

                if (data.type === 'model_list') {
                    modelList.innerHTML = "";
                    if (data.status === 'success') {
                        data.files.forEach(file => {
                            const li = document.createElement("li");
                            li.className = "list-group-item d-flex justify-content-between align-items-center";
                            li.innerHTML = `
                                <span>${file}</span>
                                <button class="btn btn-danger btn-sm" onclick="deleteModel('${file}')">ğŸ—‘ åˆªé™¤</button>
                            `;
                            modelList.appendChild(li);
                        });
                    } else {
                        modelList.innerHTML = `<li class="list-group-item text-danger">éŒ¯èª¤ï¼š${data.message}</li>`;
                    }
                }

                if (data.type === 'delete_result') {
                    if (data.status === 'success') {
                        socket.send(JSON.stringify({ action: "list-models" }));
                    } else {
                        alert("åˆªé™¤å¤±æ•—: " + data.message);
                    }
                }
            };

            window.deleteModel = function(filename) {
                if (confirm(`ç¢ºå®šè¦åˆªé™¤æ¨¡å‹ ${filename} å—ï¼Ÿ`)) {
                    socket.send(JSON.stringify({
                        action: "delete-model",
                        filename: filename
                    }));
                }
            };
        });
    </script>
</body>
</html>